import{a as x,t as h}from"../chunks/BEN_y2CW.js";import{p as ue,I as ve,F as p,c as g,G as d,t as N,g as r,J as pe,b as fe,s as v,K as _,C as S,w as B,L as Ce,f as ie}from"../chunks/BmdC9-2Z.js";import{d as me,s as te}from"../chunks/DjkWHii8.js";import{i as X}from"../chunks/BkN_-G9U.js";import{c as _e,e as ae,i as le,a as U,b as ge,s as $e,d as Se,o as Pe,C as de,m as ce,f as ee,t as Te,p as Me,g as ke}from"../chunks/a-IolG5s.js";import{p as Ae,a as s,s as q,b as be,c as J}from"../chunks/DGLH9pEx.js";import{t as Re}from"../chunks/BN5Zr6Pz.js";import{C as Le,R as je,X as ze,p as Be}from"../chunks/Cyjuakxx.js";import{A as re}from"../chunks/Y2APZMuI.js";const De=async(P,o,b)=>{v(o,!0),b.onPrint&&await b.onPrint(),await new Promise(n=>setTimeout(n,500)),v(o,!1)};var Ge=h('<p class="rounded bg-secondary/5 px-2.5 py-1"><span> </span></p>'),Ye=h('<p class="text-sm text-gray-600"> </p>'),Ee=h('<button class="rounded bg-attention p-1 px-2.5">Cancel</button>'),Fe=h('<div class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></div>'),Ie=(P,o,b,n,L)=>{q(U,!0),q(ge,s({items:n,...L}))},Ke=h('<div class="flex h-full transform flex-col justify-between rounded border-2 border-secondary/30 p-2 hover:border-2 hover:border-transparent hover:shadow-lg hover:ring-2 hover:ring-accent/50"><div><div class="small-text flex flex-wrap items-center gap-2"><!> <!></div> <div class="mt-2 h-[100px] min-h-[100px] overflow-y-scroll"></div></div> <div class="small-text mt-4 grid grid-cols-2 gap-4 text-white"><!> <button type="button" class="flex items-center justify-center gap-2 rounded bg-secondary p-1.5 px-2.5"><!> Print</button> <button class="rounded bg-accent p-1.5 px-2.5">Bill</button></div></div>');function Ne(P,o){ue(o,!0);const[b,n]=be(),L=()=>J(U,"$isModalOpen",b),H=()=>J(ge,"$activeOngoingOrder",b),w=ve(_e);let j=Ae(o,"selectedOrders",31,()=>s([])),{items:z,...T}=o.order||{},M=_(!1);const k=["order_id","order_type","room","table"];var y=Ke(),C=p(y),O=p(C),f=p(O);Le(f,{text:"",get value(){return o.order.ref},get group(){return j()},set group(c){j(c)}});var Q=g(f,2);ae(Q,17,()=>k,le,(c,l)=>{var e=Ge();const t=S(()=>{var m;return r(l)==="order_id"?"#"+((m=o.order[r(l)])==null?void 0:m.split("-").reverse()[0]):r(l)==="table"||r(l)==="room"?r(l)+": "+o.order[r(l)]:o.order[r(l)]});var a=p(e),i=p(a,!0);d(a),d(e),N(()=>{Re(e,"hidden",!o.order[r(l)]),te(i,r(t))}),x(c,e)}),d(O);var D=g(O,2);ae(D,21,()=>z,le,(c,l)=>{var e=Ye(),t=p(e);d(e),N(()=>te(t,`${r(l).quantity??""}x ${r(l).product_name??""}`)),x(c,e)}),d(D),d(C);var A=g(C,2),G=p(A);{var V=c=>{var l=Ee(),e=S(()=>$e(()=>Se(T),"Are you sure you want to cancel order "+(T.order_id||T.ref)));l.__click=function(...t){var a;(a=r(e))==null||a.apply(this,t)},x(c,l)};X(G,c=>{w.can_delete&&c(V)})}var $=g(G,2);$.__click=[De,M,o];var Y=p($);{var W=c=>{var l=Fe();x(c,l)};X(Y,c=>{r(M)&&c(W)})}pe(),d($);var E=g($,2);E.__click=[Ie,L,H,z,T],d(A),d(y),N(()=>$.disabled=r(M)),x(P,y),fe(),n()}me(["click"]);const Xe=(P,o,b)=>{if(new Set(o().map(n=>n.order_type).filter(n=>!!n)).size>1){ee("warning","You cannot merge orders of different type.");return}if(new Set(o().map(n=>n.room).filter(n=>!!n)).size>1){ee("warning","You cannot merge orders of different room.");return}if(new Set(o().map(n=>n.customer).filter(n=>!!n)).size>1){ee("warning","You cannot merge orders of different customer.");return}q(U,!0)};var qe=(P,o)=>v(o,s([])),Je=h('<button class=" flex items-center gap-2 border-b-2 border-secondary text-sm svelte-848u57"><span class="icon-parent h-3 w-3"><!></span>clear selection</button>'),Ue=h('<div class="flex w-[75%] gap-4"><!> <!> <!></div> <div class="flex items-end gap-4"><!> <button class="w-max rounded border border-accent p-3 text-accent ring-accent hover:ring-2 svelte-848u57"> </button></div>',1),He=h('<div class=" w-full"><!></div>'),Qe=h('<div class="grid grid-cols-4 gap-8"></div>'),Ve=h('<!> <div class="print-out"><!> <!></div>',1);function ir(P,o){ue(o,!0);const[b,n]=be(),L=()=>J(ce,"$mergingOngoingOrders",b),H=()=>J(U,"$isModalOpen",b);let w=_(s([])),j=_(s([])),z=_(s([])),T=_(s([])),M=_(s([])),k=_(""),y=_(""),C=_(""),O=_(void 0),f=_(s([])),Q=S(()=>r(f).length>1);const D=Pe.subscribe(e=>{v(w,s([...e]))}),A=e=>async t=>[...e].filter(a=>{const i=a.name.toLowerCase(),m=t.toLowerCase();return i.includes(m)||m.includes(i)}),G=e=>{let t=[];r(f).forEach(a=>{e.find(i=>i.ref===a)||t.push(a)}),t.forEach(a=>{v(f,s(r(f).filter(i=>i!==a)))})};async function V(e){const{data:t}=await Me.asyncGet();if(t!=null&&t.is_server_print_enabled)try{await Be(e.order_id)}catch(a){console.error("Failed to print order:",a)}else v(O,s(e)),setTimeout(()=>{print(),setTimeout(()=>{v(O,void 0)},5e3)},1e3)}B(()=>{v(z,s(Array.from(new Set(r(w).map(e=>{var t;return((t=e.room)==null?void 0:t.trim())||""}).filter(e=>!!e))).map(e=>({name:e,value:e})))),v(T,s(Array.from(new Set(r(w).map(e=>{var t;return((t=e.table)==null?void 0:t.trim())||""}).filter(e=>!!e))).map(e=>({name:e,value:e})))),v(M,s(Array.from(new Set(r(w).map(e=>{var t;return((t=e.customer)==null?void 0:t.trim())||""}).filter(e=>!!e))).map(e=>({name:e,value:e}))))}),B(()=>{v(j,s([...r(w)].filter(e=>[r(y)?e.table===r(y):!0,r(k)?e.room===r(k):!0,r(C)?e.customer===r(C):!0].every(Boolean))))}),B(()=>{q(ce,s(r(f).map(e=>r(w).find(t=>t.ref===e)).filter(e=>!!e)))}),B(()=>{G(r(w))}),B(()=>{}),Ce(()=>{D()});var $=Ve(),Y=ie($);{var W=e=>{const t=S(()=>{var i;return((i=ve(_e))==null?void 0:i.fullname)||""}),a=S(()=>r(O).is_paid===0);je(e,{get order(){return r(O)},get cashierName(){return r(t)},get isCredit(){return r(a)}})};X(Y,e=>{r(O)&&e(W)})}var E=g(Y,2),c=p(E);de(c,{class:"flex justify-between gap-6",children:(e,t)=>{var a=Ue(),i=ie(a),m=p(i);const R=S(()=>A(r(z)));re(m,{noResultText:"",get keyword(){return r(k)},onCloseSelect:u=>{v(k,s((u==null?void 0:u.name)||""))},containerClass:"w-full",label:"Room",get search(){return r(R)}});var F=g(m,2);const Z=S(()=>A(r(M)));re(F,{noResultText:"",get keyword(){return r(C)},onCloseSelect:u=>{v(C,s((u==null?void 0:u.name)||""))},containerClass:"w-full",label:"Customer",get search(){return r(Z)}});var xe=g(F,2);const he=S(()=>A(r(T)));re(xe,{noResultText:"",get keyword(){return r(y)},onCloseSelect:u=>{v(y,s((u==null?void 0:u.name)||""))},containerClass:"w-full",label:"Table",get search(){return r(he)}}),d(i);var oe=g(i,2),se=p(oe);{var we=u=>{var K=Je();K.__click=[qe,f];var ne=p(K),ye=p(ne);ze(ye),d(ne),pe(),d(K),x(u,K)};X(se,u=>{r(f).length&&u(we)})}var I=g(se,2);I.__click=[Xe,L,H];var Oe=p(I);d(I),d(oe),N(()=>{I.disabled=!r(Q),te(Oe,`Merge (${r(f).length??""})`)}),x(e,a)},$$slots:{default:!0}});var l=g(c,2);de(l,{class:"scrollbar scrollbar-sm h-[calc(100vh-70px-70px-24px)] overflow-y-auto py-6",children:(e,t)=>{var a=Qe();ae(a,21,()=>[...r(j)].reverse(),i=>i.ref,(i,m)=>{var R=He(),F=p(R);Ne(F,{get order(){return r(m)},onPrint:()=>V(r(m)),get selectedOrders(){return r(f)},set selectedOrders(Z){v(f,s(Z))}}),d(R),Te(3,R,()=>ke,()=>({duration:350})),x(i,R)}),d(a),x(e,a)},$$slots:{default:!0}}),d(E),x(P,$),fe(),n()}me(["click"]);export{ir as component};
