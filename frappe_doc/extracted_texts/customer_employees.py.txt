# Copyright (c) 2024, erpera and contributors
# For license information, please see license.txt

import frappe
from frappe.model.document import Document
from frappe.utils import cint


class CustomerEmployees(Document):
    def validate(self):
        if not self.aadhaar_number:
            self.is_kyc_done = 0
        else:
            self.is_kyc_done = 1
        if not frappe.db.exists("User", self.email):
            user = frappe.get_doc({
                "doctype": "User",
                "username": self.email,
                "email": self.email,
                "first_name": self.full_name,
                "role_profile_name": "Space Admin",
                "new_password": self.get_password("password"),
                "send_welcome_email": 0,
                # "customer": self.customer,
                "mobile_no": self.mobile,
            })
            user.save(ignore_permissions=True)
            if self.customer:
                self.add_user_to_customer_table(user.name)
                frappe.db.commit()
        else:
            user = frappe.get_doc("User", self.email)
            user.first_name = self.full_name
            user.mobile_no = self.mobile
            user.save(ignore_permissions=True)
    
            
          
    # def autoname(self):
    #     docs = frappe.get_all("Customer Employees", filters={"customer": self.customer}, fields=["name"])
    #     if docs:
    #             last_doc = frappe.get_last_doc("Customer Employees", {"customer": self.customer})
    #             count = last_doc.name[-2:]
    #             count = cint(count) + 1
    #             self.name = f"COM_{self.abbr}_{count:02}"
                
        # else:
        #         self.name = f"COM_{self.abbr}_01"
    def add_user_to_customer_table(self, user):

        if user and self.customer:
            try:
                customer = frappe.get_doc("Customer", self.customer)
                if user in [d.user for d in customer.custom_customer_users]:
                    return
                customer.append("custom_customer_users", {
                    "user": user,
                    "role": "Space User"
                })
                customer.save(ignore_permissions=True)
                frappe.db.commit()
                return customer.name
            except Exception as e:
                return e
    def after_insert(self):
        self.add_user_to_customer_table(self.email)
                
			
        