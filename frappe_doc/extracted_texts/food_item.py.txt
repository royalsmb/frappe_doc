# Copyright (c) 2024, Jokoor and contributors
# For license information, please see license.txt

import frappe
from frappe.model.document import Document


class FoodItem(Document):
	def validate(self):
		if not frappe.db.exists('Item', self.item_name):
			item = frappe.new_doc('Item')
			item.item_code = self.item_name
			item.item_name = self.item_name
			item.item_group = self.item_group
			item.standard_rate = self.item_price
			item.is_purchase_item = self.allow_purchase
			item.is_sales_item = self.allow_selling
			item.is_stock_item = self.maintain_stock
			if self.tax:
				item.append('taxes', {
				'item_tax_template': self.tax
				})
			item.save()
			frappe.db.commit()
		else:
			item = frappe.get_doc('Item', self.item_name)
			item.item_group = self.item_group
			item.is_purchase_item = self.allow_purchase
			item.is_sales_item = self.allow_selling
			item.is_stock_item = self.maintain_stock
			
			if self.tax and not item.taxes:
				item.append('taxes', {
				'item_tax_template': self.tax
				})
			if self.disabled:
				item.disabled = 1
			if frappe.db.exists('Item Price', {'item_code': self.item_name, 'price_list': 'Standard Selling'}):
				item_price = frappe.get_doc('Item Price', {'item_code': self.item_name})
				item_price.price_list_rate = self.item_price
				item_price.save()
			else:
				item_price = frappe.new_doc('Item Price')
				item_price.price_list = 'Standard Selling'
				item_price.item_code = self.item_name
				item_price.price_list_rate = self.item_price
				item_price.selling = 1
				item_price.save()

			item.save()
			frappe.db.commit()
	def on_trash(self):
		if frappe.db.exists('Item', self.item_name):
			frappe.delete_doc('Item', self.item_name)
		if frappe.db.exists('Item Price', {'item_code': self.item_name, 'price_list': 'Standard Selling'}):
			frappe.delete_doc('Item Price', {'item_code': self.item_name, 'price_list': 'Standard Selling'})
		frappe.db.commit()
	# def before_rename

	def before_rename(self, old_name, new_name, merge=False):
		# Rename the related Item document
		if frappe.db.exists('Item', old_name):
			frappe.rename_doc('Item', old_name, new_name, merge=merge)

		# Rename the related Item Price document
		if frappe.db.exists('Item Price', {'item_code': old_name, 'price_list': 'Standard Selling'}):
			item_price = frappe.get_doc('Item Price', {'item_code': old_name})
			item_price.item_code = new_name
			item_price.save()

		frappe.db.commit()

